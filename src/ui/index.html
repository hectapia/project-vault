<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fbudget</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #121212; }
        .project-card { cursor: pointer; transition: transform 0.2s; }
        .project-card:hover { transform: translateY(-5px); border-color: #0d6efd; }
        .view-section { display: none; }
        .active-section { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="p-4">

    <nav class="navbar navbar-expand-lg bg-body-tertiary rounded mb-4 px-3">
        <span class="navbar-brand mb-0 h1"><i class="bi bi-safe2-fill text-primary"></i> Fast budgeting</span>
        <div class="ms-auto text-success" id="connection-status">‚óè System Online</div>
    </nav>

    <div id="view-dashboard" class="view-section active-section">
        <div class="d-flex justify-content-between mb-4">
            <h3><i class="bi bi-grid"></i> Active Projects</h3>
            <button class="btn btn-primary" onclick="toggleAddForm()"><i class="bi bi-plus-lg"></i> New Project</button>
        </div>

        <div id="add-form-card" class="card mb-4 p-3 d-none border-primary">
            <div class="row g-2">
                <div class="col-md-4"><input type="text" id="in-name" class="form-control" placeholder="Project Name"></div>
                <div class="col-md-3"><input type="text" id="in-client" class="form-control" placeholder="Client"></div>
                <div class="col-md-2"><select id="in-status" class="form-select"><option>Active</option><option>Planning</option><option>Done</option></select></div>
                <div class="col-md-2"><input type="number" id="in-budget" class="form-control" placeholder="Budget"></div>
                <div class="col-md-1"><button class="btn btn-success w-100" onclick="addProject()">Save</button></div>
            </div>
        </div>

        <div id="project-list" class="row row-cols-1 row-cols-md-3 g-4"></div>
    </div>

    <div id="view-details" class="view-section">
        <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-outline-secondary" onclick="showDashboard()"><i class="bi bi-arrow-left"></i> Back</button>
            <div>
                <button class="btn btn-outline-warning me-2" onclick="enableEditMode()"><i class="bi bi-pencil"></i> Edit Project</button>
                <button class="btn btn-outline-danger" onclick="deleteCurrentProject()"><i class="bi bi-trash"></i> Delete Project</button>
            </div>
        </div>
        
        <div class="card p-4 mb-4">
            <div id="display-mode">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 id="detail-title" class="text-primary display-6 fw-bold mb-0">Project Name</h2>
                    <div class="text-end">
                        <small class="text-secondary">Remaining Budget</small>
                        <h3 id="detail-remaining" class="text-success fw-bold">$0.00</h3>
                    </div>
                </div>
                <hr>
                <div class="d-flex gap-4 text-secondary">
                    <span id="detail-client" class="fs-5">Client: Tesla</span>
                    <span id="detail-budget" class="fs-5">Total: $50,000</span>
                    <span id="detail-status" class="badge bg-secondary align-self-center">Active</span>
                </div>
            </div>
            
            <div id="edit-mode" class="d-none row g-2">
                <div class="col-md-4"><input type="text" id="edit-name" class="form-control"></div>
                <div class="col-md-3"><input type="text" id="edit-client" class="form-control"></div>
                <div class="col-md-2"><select id="edit-status" class="form-select"><option>Active</option><option>Planning</option><option>Done</option></select></div>
                <div class="col-md-2"><input type="number" id="edit-budget" class="form-control"></div>
                <div class="col-md-1"><button class="btn btn-success w-100" onclick="saveProjectEdits()">Save</button></div>
            </div>
        </div>

        <div class="card p-4">
            <h5>üí∞ Transactions</h5>
            
            <div class="input-group mb-3 mt-3">
                <input type="text" id="tx-desc" class="form-control" placeholder="Description">
                <input type="number" id="tx-amount" class="form-control" placeholder="Amount ($)">
                <button id="btn-tx-action" class="btn btn-outline-success" type="button" onclick="handleTransactionSubmit()">Add Expense</button>
                <button id="btn-tx-cancel" class="btn btn-outline-secondary d-none" type="button" onclick="resetTxForm()">Cancel</button>
            </div>

            <table class="table table-dark table-hover mt-3 align-middle">
                <thead><tr><th>Description</th><th>Date</th><th class="text-end">Amount</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="tx-list"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000/api";
        let currentProject = null;
        let currentTransactionsList = []; // NEW: Store fetched transactions here
        let editingTxId = null;

        // --- NAVIGATION ---
        function showDashboard() {
            document.getElementById('view-details').classList.remove('active-section');
            document.getElementById('view-dashboard').classList.add('active-section');
            fetchProjects();
        }

        async function showDetails(project) {
            currentProject = project;
            document.getElementById('view-dashboard').classList.remove('active-section');
            document.getElementById('view-details').classList.add('active-section');
            
            // Populate Display
            document.getElementById('detail-title').innerText = project.name;
            document.getElementById('detail-client').innerText = `Client: ${project.client}`;
            document.getElementById('detail-budget').innerText = `Total: $${project.budget.toLocaleString()}`;
            document.getElementById('detail-status').innerText = project.status;

            // Populate Edit Inputs
            document.getElementById('edit-name').value = project.name;
            document.getElementById('edit-client').value = project.client;
            document.getElementById('edit-status').value = project.status;
            document.getElementById('edit-budget').value = project.budget;

            document.getElementById('display-mode').classList.remove('d-none');
            document.getElementById('edit-mode').classList.add('d-none');
            resetTxForm();
            await loadTransactions(project.id);
        }

        // --- TRANSACTIONS LOGIC ---
        async function loadTransactions(projectId) {
            const res = await fetch(`${API_URL}/projects/${projectId}/transactions`);
            const txs = await res.json();
            
            currentTransactionsList = txs; // SAVE DATA GLOBALLY
            
            const tbody = document.getElementById('tx-list');
            tbody.innerHTML = '';
            
            let totalSpent = 0;

            txs.forEach(tx => {
                totalSpent += tx.amount;
                // FIX: Pass only the ID to startEditTx, not the whole object
                const row = `<tr>
                    <td>${tx.description}</td>
                    <td>${tx.date || '-'}</td>
                    <td class="text-end text-danger">-$${tx.amount.toLocaleString()}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-light me-1" onclick="startEditTx(${tx.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTx(${tx.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // UPDATE REMAINING BUDGET
            const remaining = currentProject.budget - totalSpent;
            const remEl = document.getElementById('detail-remaining');
            remEl.innerText = `$${remaining.toLocaleString()}`;
            remEl.className = remaining < 0 ? "text-danger fw-bold" : "text-success fw-bold";
        }

        function handleTransactionSubmit() {
            if (editingTxId) {
                updateTransaction();
            } else {
                addTransaction();
            }
        }

        async function addTransaction() {
            if(!currentProject) return;
            const desc = document.getElementById('tx-desc').value;
            const amt = document.getElementById('tx-amount').value;
            if(!desc || !amt) return;

            await fetch(`${API_URL}/transactions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    project_id: currentProject.id, description: desc,
                    amount: parseFloat(amt), date: new Date().toLocaleDateString()
                })
            });
            resetTxForm();
            loadTransactions(currentProject.id);
        }

        // FIX: Find the transaction object using the ID
        function startEditTx(id) {
            const tx = currentTransactionsList.find(t => t.id === id);
            if (!tx) return;

            editingTxId = tx.id;
            document.getElementById('tx-desc').value = tx.description;
            document.getElementById('tx-amount').value = tx.amount;
            
            document.getElementById('btn-tx-action').innerText = "Update Expense";
            document.getElementById('btn-tx-action').classList.replace('btn-outline-success', 'btn-warning');
            document.getElementById('btn-tx-cancel').classList.remove('d-none');
        }

        async function updateTransaction() {
            const desc = document.getElementById('tx-desc').value;
            const amt = document.getElementById('tx-amount').value;
            
            await fetch(`${API_URL}/transactions/${editingTxId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    description: desc, amount: parseFloat(amt), date: new Date().toLocaleDateString()
                })
            });
            resetTxForm();
            loadTransactions(currentProject.id);
        }

        async function deleteTx(id) {
            if(!confirm("Delete this expense?")) return;
            await fetch(`${API_URL}/transactions/${id}`, { method: 'DELETE' });
            loadTransactions(currentProject.id);
        }

        function resetTxForm() {
            editingTxId = null;
            document.getElementById('tx-desc').value = '';
            document.getElementById('tx-amount').value = '';
            document.getElementById('btn-tx-action').innerText = "Add Expense";
            document.getElementById('btn-tx-action').classList.replace('btn-warning', 'btn-outline-success');
            document.getElementById('btn-tx-action').classList.add('btn-outline-success'); // Ensure class exists
            document.getElementById('btn-tx-cancel').classList.add('d-none');
        }

        // --- PROJECT CRUD ---
        function enableEditMode() {
            document.getElementById('display-mode').classList.add('d-none');
            document.getElementById('edit-mode').classList.remove('d-none');
        }
        async function saveProjectEdits() {
            const updatedData = {
                name: document.getElementById('edit-name').value,
                client: document.getElementById('edit-client').value,
                status: document.getElementById('edit-status').value,
                budget: parseFloat(document.getElementById('edit-budget').value)
            };
            await fetch(`${API_URL}/projects/${currentProject.id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(updatedData)
            });
            currentProject = {...currentProject, ...updatedData};
            showDetails(currentProject);
        }
        async function deleteCurrentProject() {
            if(!confirm("Are you sure?")) return;
            await fetch(`${API_URL}/projects/${currentProject.id}`, { method: 'DELETE' });
            showDashboard();
        }
        function toggleAddForm() { document.getElementById('add-form-card').classList.toggle('d-none'); }
        async function fetchProjects() {
            try {
                const res = await fetch(`${API_URL}/projects`);
                const projects = await res.json();
                const container = document.getElementById('project-list');
                container.innerHTML = '';
                projects.forEach(p => {
                    container.innerHTML += `
                        <div class="col"><div class="card h-100 project-card shadow-sm" onclick='showDetails(${JSON.stringify(p)})'>
                            <div class="card-body">
                                <h5 class="card-title text-light">${p.name}</h5>
                                <p class="card-text text-secondary mb-1">${p.client}</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <span class="badge bg-secondary">${p.status}</span>
                                    <span class="text-success fw-bold">$${p.budget.toLocaleString()}</span>
                                </div>
                            </div>
                        </div></div>`;
                });
            } catch (err) { console.error(err); }
        }
        async function addProject() {
            const name = document.getElementById('in-name').value;
            const client = document.getElementById('in-client').value;
            const status = document.getElementById('in-status').value;
            const budget = document.getElementById('in-budget').value;
            if(!name || !budget) { alert("Name and Budget required"); return; }
            await fetch(`${API_URL}/projects`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, client, status, budget: parseFloat(budget) })
            });
            document.getElementById('in-name').value = "";
            document.getElementById('in-budget').value = "";
            toggleAddForm();
            fetchProjects();
        }

        fetchProjects();
    </script>
</body>
</html>