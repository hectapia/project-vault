<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fbudget</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #121212; }
        .project-card { cursor: pointer; transition: transform 0.2s; }
        .project-card:hover { transform: translateY(-5px); border-color: #0d6efd; }
        .view-section { display: none; }
        .active-section { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Chart Container */
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
    </style>
</head>
<body class="p-4">

    <nav class="navbar navbar-expand-lg bg-body-tertiary rounded mb-4 px-3">
        <span class="navbar-brand mb-0 h1"><i class="bi bi-safe2-fill text-primary"></i> Project Vault</span>
        <div class="ms-auto text-success" id="connection-status">‚óè System Online</div>
    </nav>

    <div id="view-dashboard" class="view-section active-section">
        <div class="d-flex justify-content-between mb-4">
            <h3><i class="bi bi-grid"></i> Active Projects</h3>
            <button class="btn btn-primary" onclick="toggleAddForm()"><i class="bi bi-plus-lg"></i> New Project</button>
        </div>

        <div id="add-form-card" class="card mb-4 p-3 d-none border-primary">
            <div class="row g-2">
                <div class="col-md-4"><input type="text" id="in-name" class="form-control" placeholder="Project Name"></div>
                <div class="col-md-3"><input type="text" id="in-client" class="form-control" placeholder="Client"></div>
                <div class="col-md-2"><select id="in-status" class="form-select"><option>Active</option><option>Planning</option><option>Done</option></select></div>
                <div class="col-md-2"><input type="number" id="in-budget" class="form-control" placeholder="Budget"></div>
                <div class="col-md-1"><button class="btn btn-success w-100" onclick="addProject()">Save</button></div>
            </div>
        </div>

        <div id="project-list" class="row row-cols-1 row-cols-md-3 g-4"></div>
    </div>

    <div id="view-details" class="view-section">
        <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-outline-secondary" onclick="showDashboard()"><i class="bi bi-arrow-left"></i> Back</button>
            <div>
                <button class="btn btn-outline-light me-2" onclick="exportToCSV()"><i class="bi bi-file-earmark-spreadsheet"></i> Export CSV</button>
                <button class="btn btn-outline-warning me-2" onclick="enableEditMode()"><i class="bi bi-pencil"></i> Edit</button>
                <button class="btn btn-outline-danger" onclick="deleteCurrentProject()"><i class="bi bi-trash"></i></button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-5 mb-4">
                <div class="card p-4 h-100">
                    <div id="display-mode">
                        <h2 id="detail-title" class="text-primary fw-bold">Project Name</h2>
                        <div class="text-secondary mb-3">
                            <span id="detail-client">Client: Tesla</span> <br>
                            <span id="detail-status" class="badge bg-secondary">Active</span>
                        </div>
                        <h4 class="mt-4">Budget Overview</h4>
                        <div class="chart-container">
                            <canvas id="budgetChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="fs-5">Remaining: <span id="detail-remaining" class="fw-bold text-success">$0.00</span></span>
                            <br>
                            <small class="text-secondary">Total Budget: <span id="detail-budget">$0</span></small>
                        </div>
                    </div>

                    <div id="edit-mode" class="d-none row g-2">
                        <div class="col-12"><label>Name</label><input type="text" id="edit-name" class="form-control"></div>
                        <div class="col-6"><label>Client</label><input type="text" id="edit-client" class="form-control"></div>
                        <div class="col-6"><label>Status</label><select id="edit-status" class="form-select"><option>Active</option><option>Planning</option><option>Done</option></select></div>
                        <div class="col-12"><label>Budget</label><input type="number" id="edit-budget" class="form-control"></div>
                        <div class="col-12 mt-3"><button class="btn btn-success w-100" onclick="saveProjectEdits()">Save Changes</button></div>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card p-4 h-100">
                    <h5>üí∞ Expenses</h5>
                    <div class="input-group mb-3 mt-3">
                        <input type="text" id="tx-desc" class="form-control" placeholder="Description" style="width: 30%;">
                        <select id="tx-category" class="form-select" style="width: 25%;">
                            <option value="Materials">üß± Materials</option>
                            <option value="Labor">üë∑ Labor</option>
                            <option value="Logistics">üöö Logistics</option>
                            <option value="Equipment">‚öôÔ∏è Equipment</option>
                            <option value="Other">üìù Other</option>
                        </select>
                        <input type="number" id="tx-amount" class="form-control" placeholder="$$" style="width: 20%;">
                        <button id="btn-tx-action" class="btn btn-outline-success" onclick="handleTransactionSubmit()">Add</button>
                        <button id="btn-tx-cancel" class="btn btn-outline-secondary d-none" onclick="resetTxForm()">X</button>
                    </div>

                    <div style="overflow-y: auto; max-height: 500px;">
                        <table class="table table-dark table-hover mt-2 align-middle">
                            <tbody id="tx-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000/api";
        let currentProject = null;
        let currentTransactionsList = [];
        let editingTxId = null;
        let myChart = null; // Store chart instance

        // --- NAVIGATION ---
        function showDashboard() {
            document.getElementById('view-details').classList.remove('active-section');
            document.getElementById('view-dashboard').classList.add('active-section');
            fetchProjects();
        }

        async function showDetails(project) {
            currentProject = project;
            document.getElementById('view-dashboard').classList.remove('active-section');
            document.getElementById('view-details').classList.add('active-section');
            
            document.getElementById('detail-title').innerText = project.name;
            document.getElementById('detail-client').innerText = `Client: ${project.client}`;
            document.getElementById('detail-budget').innerText = `$${project.budget.toLocaleString()}`;
            document.getElementById('detail-status').innerText = project.status;

            // Pre-fill Edit Inputs
            document.getElementById('edit-name').value = project.name;
            document.getElementById('edit-client').value = project.client;
            document.getElementById('edit-status').value = project.status;
            document.getElementById('edit-budget').value = project.budget;

            document.getElementById('display-mode').classList.remove('d-none');
            document.getElementById('edit-mode').classList.add('d-none');
            resetTxForm();
            await loadTransactions(project.id);
        }

        // --- CHART & DATA LOGIC ---
        function updateChart(totalSpent, categories) {
            const ctx = document.getElementById('budgetChart').getContext('2d');
            const remaining = Math.max(0, currentProject.budget - totalSpent);

            // Destroy old chart to prevent glitches
            if (myChart) myChart.destroy();

            // Prepare Data
            const labels = Object.keys(categories);
            const data = Object.values(categories);
            
            // Add "Remaining" to the visualization
            labels.push("Remaining Budget");
            data.push(remaining);

            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#28a745']; // Last is green for remaining

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } }
                    }
                }
            });
        }

        async function loadTransactions(projectId) {
            const res = await fetch(`${API_URL}/projects/${projectId}/transactions`);
            const txs = await res.json();
            currentTransactionsList = txs;
            
            const tbody = document.getElementById('tx-list');
            tbody.innerHTML = '';
            
            let totalSpent = 0;
            // Accumulate category spending for chart
            let categoryTotals = {}; 

            txs.forEach(tx => {
                totalSpent += tx.amount;
                
                // Track Categories
                const cat = tx.category || "Other";
                categoryTotals[cat] = (categoryTotals[cat] || 0) + tx.amount;

                // Category Badge Logic
                let badgeClass = "bg-secondary";
                if(cat === "Materials") badgeClass = "bg-danger";
                if(cat === "Labor") badgeClass = "bg-primary";
                if(cat === "Logistics") badgeClass = "bg-warning text-dark";
                if(cat === "Equipment") badgeClass = "bg-info text-dark";

                const row = `<tr>
                    <td>
                        <span class="badge ${badgeClass} me-2">${cat}</span>
                        ${tx.description}
                    </td>
                    <td class="text-end text-danger">-$${tx.amount.toLocaleString()}</td>
                    <td class="text-end" style="width: 80px;">
                        <button class="btn btn-sm btn-outline-light" onclick="startEditTx(${tx.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTx(${tx.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // Update Remaining Text
            const remaining = currentProject.budget - totalSpent;
            const remEl = document.getElementById('detail-remaining');
            remEl.innerText = `$${remaining.toLocaleString()}`;
            remEl.className = remaining < 0 ? "text-danger fw-bold" : "text-success fw-bold";

            // Render Chart
            updateChart(totalSpent, categoryTotals);
        }

        // --- CRUD LOGIC ---
        function handleTransactionSubmit() {
            if (editingTxId) updateTransaction();
            else addTransaction();
        }

        async function addTransaction() {
            if(!currentProject) return;
            const desc = document.getElementById('tx-desc').value;
            const cat = document.getElementById('tx-category').value;
            const amt = document.getElementById('tx-amount').value;
            if(!desc || !amt) return;

            await fetch(`${API_URL}/transactions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    project_id: currentProject.id, description: desc,
                    category: cat, amount: parseFloat(amt), date: new Date().toLocaleDateString()
                })
            });
            resetTxForm();
            loadTransactions(currentProject.id);
        }

        function startEditTx(id) {
            const tx = currentTransactionsList.find(t => t.id === id);
            if (!tx) return;
            editingTxId = tx.id;
            document.getElementById('tx-desc').value = tx.description;
            document.getElementById('tx-category').value = tx.category || "Other";
            document.getElementById('tx-amount').value = tx.amount;
            
            document.getElementById('btn-tx-action').innerText = "Update";
            document.getElementById('btn-tx-action').className = "btn btn-warning";
            document.getElementById('btn-tx-cancel').classList.remove('d-none');
        }

        async function updateTransaction() {
            await fetch(`${API_URL}/transactions/${editingTxId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    description: document.getElementById('tx-desc').value,
                    category: document.getElementById('tx-category').value,
                    amount: parseFloat(document.getElementById('tx-amount').value),
                    date: new Date().toLocaleDateString()
                })
            });
            resetTxForm();
            loadTransactions(currentProject.id);
        }

        async function deleteTx(id) {
            if(!confirm("Delete?")) return;
            await fetch(`${API_URL}/transactions/${id}`, { method: 'DELETE' });
            loadTransactions(currentProject.id);
        }

        function resetTxForm() {
            editingTxId = null;
            document.getElementById('tx-desc').value = '';
            document.getElementById('tx-amount').value = '';
            document.getElementById('btn-tx-action').innerText = "Add";
            document.getElementById('btn-tx-action').className = "btn btn-outline-success";
            document.getElementById('btn-tx-cancel').classList.add('d-none');
        }

        // --- UTILS ---
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Category,Description,Date,Amount\n";
            currentTransactionsList.forEach(row => {
                csvContent += `${row.category || 'Other'},${row.description},${row.date},${row.amount}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentProject.name}_expenses.csv`);
            document.body.appendChild(link);
            link.click();
        }

        function enableEditMode() { document.getElementById('display-mode').classList.add('d-none'); document.getElementById('edit-mode').classList.remove('d-none'); }
        async function saveProjectEdits() {
            const updated = {
                name: document.getElementById('edit-name').value,
                client: document.getElementById('edit-client').value,
                status: document.getElementById('edit-status').value,
                budget: parseFloat(document.getElementById('edit-budget').value)
            };
            await fetch(`${API_URL}/projects/${currentProject.id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(updated)});
            currentProject = {...currentProject, ...updated};
            showDetails(currentProject);
        }
        async function deleteCurrentProject() { if(confirm("Delete Project?")) { await fetch(`${API_URL}/projects/${currentProject.id}`, { method: 'DELETE' }); showDashboard(); }}
        function toggleAddForm() { document.getElementById('add-form-card').classList.toggle('d-none'); }
        async function fetchProjects() {
            const res = await fetch(`${API_URL}/projects`);
            const projects = await res.json();
            const container = document.getElementById('project-list');
            container.innerHTML = '';
            projects.forEach(p => {
                container.innerHTML += `
                    <div class="col"><div class="card h-100 project-card shadow-sm" onclick='showDetails(${JSON.stringify(p)})'>
                        <div class="card-body">
                            <h5 class="card-title text-light">${p.name}</h5>
                            <p class="card-text text-secondary mb-1">${p.client}</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="badge bg-secondary">${p.status}</span>
                                <span class="text-success fw-bold">$${p.budget.toLocaleString()}</span>
                            </div>
                        </div>
                    </div></div>`;
            });
        }
        async function addProject() {
            const name = document.getElementById('in-name').value;
            const budget = document.getElementById('in-budget').value;
            if(!name || !budget) return;
            await fetch(`${API_URL}/projects`, { method: 'POST', headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({ name, client: document.getElementById('in-client').value, status: document.getElementById('in-status').value, budget: parseFloat(budget)}) });
            toggleAddForm(); fetchProjects();
        }
        
        fetchProjects();
    </script>
</body>
</html>